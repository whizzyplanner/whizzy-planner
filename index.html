
<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WHIZZYPLANNER 2026</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏳</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        whizzy: {
                            red: '#DC2626',
                            dark: '#050505',
                            surface: '#121212',
                            input: '#1E1E1E',
                            text: '#E0E0E0'
                        }
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                        serif: ['Playfair Display', 'serif']
                    }
                }
            }
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        body { 
            background-color: #f3f4f6; color: #1f2937; font-family: 'Roboto', sans-serif; overflow: hidden; 
        }
        .dark body { background-color: #000; color: #E0E0E0; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .dark ::-webkit-scrollbar-track { background: #000; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #DC2626; }

        .floating-input { position: relative; margin-bottom: 1.5rem; }
        .floating-input input, .floating-input select, .floating-input textarea {
            width: 100%; background: #fff; border: 1px solid #ddd; color: #000;
            padding: 1rem 0.75rem 0.5rem; border-radius: 4px; outline: none; transition: border-color 0.2s;
        }
        .dark .floating-input input, .dark .floating-input select, .dark .floating-input textarea {
            background: #1E1E1E; border: 1px solid #333; color: white;
        }
        .floating-input input:focus, .floating-input select:focus, .floating-input textarea:focus { border-color: #DC2626; }
        .floating-input label {
            position: absolute; top: 0.75rem; left: 0.75rem; color: #888; pointer-events: none;
            transition: 0.2s ease all; font-size: 1rem;
        }
        .floating-input input:focus ~ label, .floating-input input:not(:placeholder-shown) ~ label,
        .floating-input select:focus ~ label, .floating-input select:not([value=""]):valid ~ label,
        .floating-input textarea:focus ~ label, .floating-input textarea:not(:placeholder-shown) ~ label {
            top: 0.2rem; font-size: 0.7rem; color: #DC2626;
        }

        /* Loading Bar Pulse */
        @keyframes pulse-bar { 0% { width: 10%; opacity: 0.5; } 50% { width: 60%; opacity: 1; } 100% { width: 90%; opacity: 0.8; } }
        .loading-bar-anim { animation: pulse-bar 2s infinite ease-in-out; }
        
        @keyframes spin-hourglass { 0% { transform: rotate(0deg); } 90% { transform: rotate(0deg); } 100% { transform: rotate(180deg); } }
        .logo-anim { animation: spin-hourglass 5s infinite ease-in-out; }

        /* STRICT 3-COLUMN GRID */
        .time-slot { 
            border-bottom: 1px solid #e5e7eb; height: 80px; position: relative; 
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 COLUNAS RÍGIDAS */
            gap: 2px;
            padding-left: 50px; padding-right: 4px; padding-top: 2px; padding-bottom: 2px;
        }
        .dark .time-slot { border-bottom: 1px solid #222; }
        
        /* CURRENT TIME HIGHLIGHT */
        .current-hour {
            background: rgba(220, 38, 38, 0.05); /* Slight red tint */
            border-left: 2px solid #DC2626;
        }
        
        .time-label { position: absolute; left: 5px; top: 5px; font-size: 0.75rem; font-weight: bold; color: #666; }
        .add-btn-slot {
            position: absolute; left: 2px; bottom: 2px; font-size: 12px; color: #999; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 5;
        }
        .time-slot:hover .add-btn-slot { opacity: 1; }

        .event-chip { 
            border-radius: 4px; padding: 4px; font-size: 0.7rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            position: relative; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between;
        }
        .event-chip:hover { z-index: 50; height: auto; min-height: 100%; transform: scale(1.02); transition: 0.1s; }
        
        .chip-actions { display: none; margin-top: 2px; justify-content: flex-end; gap: 2px; }
        .event-chip:hover .chip-actions { display: flex; }
        .action-icon { cursor: pointer; padding: 1px; border-radius: 2px; background: rgba(0,0,0,0.4); color: white; font-size: 14px; }
        .action-icon:hover { background: #000; }

        /* Priorities */
        .prio-0 { background: #DC2626; color: white; border: 1px solid #991b1b; } /* Muito Alta */
        .prio-1 { background: #ea580c; color: white; border: 1px solid #c2410c; } /* Alta */
        .prio-2 { background: #eab308; color: black; border: 1px solid #ca8a04; } /* Media */
        .prio-3 { background: #2563eb; color: white; border: 1px solid #1d4ed8; } /* Baixa */
        .prio-4 { background: #525252; color: white; border: 1px solid #404040; } /* Nao definida */

        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .header-icon { color: #888; transition: color 0.2s; cursor: pointer; }
        .header-icon:hover { color: #000; }
        .dark .header-icon:hover { color: #fff; }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="loader" class="loading-overlay hidden">
        <div class="text-6xl mb-4 logo-anim">⏳</div>
        <div class="text-xl font-black tracking-tighter text-whizzy-red">WHIZZYPLANNER</div>
        <div class="w-64 h-1 bg-gray-900 mt-4 rounded overflow-hidden relative">
            <div id="progress-bar" class="h-full bg-whizzy-red loading-bar-anim"></div>
        </div>
        <p id="loader-text" class="text-xs text-gray-500 mt-2 uppercase tracking-widest">CRIANDO PLANNER...</p>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="h-screen w-full flex items-center justify-center p-4 bg-black overflow-y-auto">
        <!-- Expanded width for desktop to accommodate new fields without cramping -->
        <div id="auth-container" class="w-full max-w-4xl bg-whizzy-surface p-8 rounded-lg shadow-2xl border border-gray-800 transition-all duration-300">
            <div class="text-center mb-8">
                <div class="text-5xl mb-2 inline-block logo-anim">⏳</div>
                <h1 class="text-2xl font-black tracking-tighter text-white">WHIZZYPLANNER <span class="text-whizzy-red">2026</span></h1>
            </div>

            <div class="flex mb-6 border-b border-gray-800 max-w-md mx-auto">
                <button onclick="switchAuth('login')" id="tab-login" class="flex-1 pb-2 text-whizzy-red border-b-2 border-whizzy-red font-bold">ENTRAR</button>
                <button onclick="switchAuth('register')" id="tab-register" class="flex-1 pb-2 text-gray-500 hover:text-gray-300">ATIVAR LICENÇA</button>
            </div>

            <!-- LOGIN -->
            <form id="form-login" onsubmit="handleLogin(event)" class="max-w-md mx-auto">
                <div class="floating-input">
                    <input type="email" id="login-email" placeholder=" " required>
                    <label>E-mail</label>
                </div>
                <div class="floating-input">
                    <input type="password" id="login-pass" placeholder=" " required>
                    <label>Senha</label>
                </div>
                <button type="submit" class="w-full bg-whizzy-red hover:bg-red-700 text-white font-bold py-3 rounded transition uppercase tracking-wider mb-4">Acessar Sistema</button>
                <div class="text-center">
                    <a href="#" onclick="openModal('modal-forgot')" class="text-sm text-gray-500 hover:text-white">Esqueci minha senha</a>
                </div>
            </form>

            <!-- REGISTER (GRID LAYOUT FOR DESKTOP - FIX NARROW ISSUE) -->
            <form id="form-register" class="hidden" onsubmit="handleRegister(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Col 1 -->
                    <div>
                        <div class="floating-input">
                            <input type="text" id="reg-key" placeholder=" " required style="text-transform: uppercase;">
                            <label>Chave de Ativação</label>
                        </div>
                        <div class="text-right -mt-4 mb-4">
                            <button type="button" onclick="generateTestKey()" class="bg-black border border-gray-700 text-gray-400 text-xs px-2 py-1 rounded hover:text-white uppercase">Gerar Chave (DEV)</button>
                        </div>

                        <div class="floating-input">
                            <input type="text" id="reg-name" placeholder=" " required>
                            <label>Nome Completo</label>
                        </div>
                        
                        <div class="floating-input">
                            <input type="tel" id="reg-phone" placeholder=" " required>
                            <label>Telefone (Com DDD)</label>
                        </div>
                    </div>

                    <!-- Col 2 -->
                    <div>
                        <div class="floating-input">
                            <input type="email" id="reg-email" placeholder=" " required>
                            <label>E-mail</label>
                        </div>
                        <div class="floating-input">
                            <input type="email" id="reg-email-conf" placeholder=" " required>
                            <label>Confirmar E-mail</label>
                        </div>

                        <div class="floating-input">
                            <input type="password" id="reg-pass" placeholder=" " required>
                            <label>Senha (Min 8, Num, Especial)</label>
                        </div>
                        <div class="floating-input">
                            <input type="password" id="reg-pass-conf" placeholder=" " required>
                            <label>Confirmar Senha</label>
                        </div>
                    </div>
                </div>
                
                <!-- Checkboxes Row -->
                <div class="mt-4 p-4 border border-gray-800 rounded bg-whizzy-input">
                    <p class="text-xs text-gray-400 font-bold uppercase mb-2">Receber Alertas via (Selecione pelo menos um):</p>
                    <div class="flex flex-wrap gap-4">
                        <label class="flex items-center gap-2 cursor-pointer text-gray-300 hover:text-white"><input type="checkbox" id="chk-wa" class="accent-whizzy-red w-4 h-4"> WhatsApp</label>
                        <label class="flex items-center gap-2 cursor-pointer text-gray-300 hover:text-white"><input type="checkbox" id="chk-sms" class="accent-whizzy-red w-4 h-4"> SMS</label>
                        <label class="flex items-center gap-2 cursor-pointer text-gray-300 hover:text-white"><input type="checkbox" id="chk-tg" class="accent-whizzy-red w-4 h-4"> Telegram</label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-whizzy-red text-white hover:bg-red-700 font-bold py-3 rounded transition uppercase tracking-wider mt-6">Ativar e Iniciar</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="h-screen w-full flex flex-col hidden bg-white dark:bg-black transition-colors duration-300">
        
        <!-- HEADER -->
        <header class="h-16 bg-white dark:bg-whizzy-surface border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-4 z-40">
            <div class="flex items-center gap-2">
                <button class="md:hidden header-icon" onclick="toggleMobileMenu()"><i class="material-icons">menu</i></button>
                <div class="text-2xl logo-anim cursor-pointer text-whizzy-red ml-2" onclick="showVibe()">⏳</div>
                <div class="hidden md:block font-black tracking-tighter text-black dark:text-white ml-2 text-lg">WHIZZYPLANNER</div>
            </div>
            
            <div class="flex items-center gap-6">
                <div class="text-sm text-right hidden md:block">
                    <div id="header-date" class="font-bold text-black dark:text-white uppercase tracking-wider">...</div>
                </div>

                <!-- Icons Uniform Color -->
                <button onclick="toggleTheme()" class="header-icon"><i class="material-icons" id="theme-icon">dark_mode</i></button>
                <button onclick="openModal('modal-search')" class="header-icon"><i class="material-icons">search</i></button>
                <button onclick="showVibe()" class="header-icon"><i class="material-icons">bolt</i></button>
                
                <!-- Avatar -->
                <div class="relative group" id="user-menu-container">
                    <img id="header-avatar" src="" class="w-8 h-8 rounded-full border border-gray-600 cursor-pointer object-cover hover:border-white transition">
                    <div id="user-dropdown" class="hidden absolute right-0 top-12 w-48 bg-white dark:bg-whizzy-surface border border-gray-800 shadow-xl rounded z-50">
                        <a href="#" onclick="openProfile()" class="block px-4 py-3 hover:bg-gray-100 dark:hover:bg-whizzy-input text-black dark:text-white">Perfil</a>
                        <div class="border-t border-gray-700"></div>
                        <a href="#" onclick="confirmLogout()" class="block px-4 py-3 text-whizzy-red font-bold hover:bg-gray-100 dark:hover:bg-whizzy-input">Sair</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- BODY -->
        <div class="flex-1 flex overflow-hidden relative">
            <!-- SIDEBAR -->
            <aside id="sidebar" class="bg-white dark:bg-whizzy-surface border-r border-gray-200 dark:border-gray-800 hidden md:flex flex-col w-64 pt-6 px-4">
                <div class="mb-6 sidebar-text">
                    <div class="font-bold text-xs text-gray-500 tracking-widest mb-2">NAVEGAÇÃO</div>
                    <input type="date" id="date-picker" class="w-full bg-gray-100 dark:bg-whizzy-input border border-gray-300 dark:border-gray-700 text-black dark:text-white p-2 rounded text-sm" onchange="jumpToDate(this.value)">
                    <button onclick="jumpToToday()" class="w-full mt-3 text-xs text-whizzy-red border border-whizzy-red p-2 rounded hover:bg-whizzy-red hover:text-white transition font-bold uppercase">Ir Para Hoje</button>
                </div>
            </aside>

            <!-- MAIN GRID -->
            <main class="flex-1 overflow-y-auto relative bg-gray-50 dark:bg-black transition-colors" id="planner-container">
                <div id="planner-grid" class="pb-20 md:pb-0 min-h-full"></div>
            </main>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- ALERT -->
    <div id="modal-alert" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('modal-alert')"></div>
        <div class="bg-white dark:bg-whizzy-surface w-full max-w-sm rounded border-l-4 border-whizzy-red p-6 relative z-10 shadow-2xl">
            <button onclick="closeModal('modal-alert')" class="absolute top-2 right-2 text-gray-500 hover:text-black dark:hover:text-white"><i class="material-icons">close</i></button>
            <h3 class="font-bold text-lg mb-2 text-black dark:text-white" id="alert-title">Atenção</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6" id="alert-msg">Mensagem...</p>
            <div class="flex justify-end"><button onclick="closeModal('modal-alert')" class="bg-whizzy-red text-white px-6 py-2 rounded font-bold hover:bg-red-700">OK</button></div>
        </div>
    </div>

    <!-- CONFIRM -->
    <div id="modal-confirm" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
        <div class="bg-white dark:bg-whizzy-surface w-full max-w-md rounded border border-gray-200 dark:border-gray-700 p-6 relative z-10 shadow-2xl">
            <button onclick="closeModal('modal-confirm')" class="absolute top-2 right-2 text-gray-500 hover:text-black dark:hover:text-white"><i class="material-icons">close</i></button>
            <h3 class="font-bold text-lg mb-4 text-black dark:text-white">Confirmação</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-6" id="confirm-msg">...</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('modal-confirm')" class="text-gray-500 hover:text-black dark:hover:text-white px-4 py-2">Cancelar</button>
                <button id="btn-confirm-action" class="bg-whizzy-red text-white px-6 py-2 rounded font-bold hover:bg-red-700">CONFIRMAR</button>
            </div>
        </div>
    </div>

    <!-- EVENT MODAL -->
    <div id="modal-event" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('modal-event')"></div>
        <div class="bg-white dark:bg-whizzy-surface w-full max-w-lg rounded-lg border border-gray-200 dark:border-gray-700 shadow-2xl relative z-10 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-whizzy-input">
                <h3 class="font-bold text-lg text-black dark:text-white" id="modal-title-text">Novo Compromisso</h3>
                <button onclick="closeModal('modal-event')" class="text-gray-500 hover:text-red-500"><i class="material-icons">close</i></button>
            </div>
            <form id="form-event" class="p-6 overflow-y-auto" onsubmit="saveEvent(event)">
                <input type="hidden" id="evt-id">
                
                <div class="floating-input">
                    <input type="text" id="evt-title" placeholder=" " required>
                    <label>Título (O que vai fazer?)</label>
                </div>

                <div class="flex gap-4 mb-2">
                    <div class="floating-input flex-1">
                        <select id="evt-start-h" required class="appearance-none"></select>
                        <label>Hora</label>
                    </div>
                    <div class="floating-input flex-1">
                        <select id="evt-start-m" required class="appearance-none">
                            <option value="00">00</option><option value="15">15</option>
                            <option value="30">30</option><option value="45">45</option>
                        </select>
                        <label>Min</label>
                    </div>
                </div>

                <div class="flex gap-4 mb-2">
                    <div class="floating-input flex-1">
                        <select id="evt-dur-h" required class="appearance-none"></select>
                        <label>Duração (H)</label>
                    </div>
                    <div class="floating-input flex-1">
                        <select id="evt-dur-m" required class="appearance-none">
                            <option value="0">00</option><option value="15">15</option>
                            <option value="30">30</option><option value="45">45</option>
                        </select>
                        <label>Duração (M)</label>
                    </div>
                </div>

                <div class="flex gap-4">
                    <div class="floating-input flex-1">
                        <select id="evt-priority" class="appearance-none">
                            <option value="0">Muito Alta</option>
                            <option value="1">Alta</option>
                            <option value="2">Média</option>
                            <option value="3">Baixa</option>
                            <option value="4">Não definida</option>
                        </select>
                        <label>Prioridade</label>
                    </div>
                    <div class="floating-input flex-1 hidden" id="div-status">
                        <select id="evt-status" class="appearance-none">
                            <option value="OPEN">Aberto</option>
                            <option value="IN_PROGRESS">Iniciado</option>
                            <option value="DONE">Finalizado</option>
                            <option value="MOVED">Transferido</option>
                        </select>
                        <label>Status</label>
                    </div>
                </div>

                <div class="floating-input">
                    <textarea id="evt-notes" placeholder=" " rows="3"></textarea>
                    <label>Observações</label>
                </div>

                <button type="submit" class="w-full bg-whizzy-red text-white font-bold py-3 rounded hover:bg-red-700 mt-4">SALVAR</button>
            </form>
        </div>
    </div>

    <!-- PROFILE MODAL (TABBED) -->
    <div id="modal-profile" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('modal-profile')"></div>
        <div class="bg-white dark:bg-whizzy-surface w-full max-w-lg rounded-lg relative z-10 overflow-hidden flex flex-col max-h-[90vh] border border-gray-700">
            <div class="flex justify-between items-center p-4 border-b border-gray-700 bg-whizzy-input">
                <h3 class="font-bold text-lg text-white">Meu Perfil</h3>
                <button onclick="closeModal('modal-profile')" class="text-white"><i class="material-icons">close</i></button>
            </div>
            
            <div class="flex bg-black">
                <button onclick="switchProfileTab('data')" id="ptab-data" class="flex-1 py-3 text-sm font-bold text-whizzy-red border-b-2 border-whizzy-red">DADOS</button>
                <button onclick="switchProfileTab('access')" id="ptab-access" class="flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent">ACESSO</button>
                <button onclick="switchProfileTab('security')" id="ptab-security" class="flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent">SEGURANÇA</button>
            </div>

            <form onsubmit="updateProfileSubmit(event)" class="p-6 overflow-y-auto">
                <!-- DATA TAB -->
                <div id="pcontent-data">
                    <div class="floating-input">
                        <input type="text" id="prof-name" placeholder=" " required>
                        <label>Nome de Exibição</label>
                    </div>
                    <div class="floating-input">
                        <input type="url" id="prof-photo" placeholder=" ">
                        <label>URL da Foto</label>
                    </div>
                    <div class="floating-input">
                        <input type="tel" id="prof-phone" placeholder=" ">
                        <label>Telefone</label>
                    </div>
                </div>

                <!-- ACCESS TAB -->
                <div id="pcontent-access" class="hidden">
                    <div class="bg-gray-800 p-4 rounded text-center mb-4">
                        <p class="text-xs text-gray-400 uppercase font-bold">Seu E-mail de Acesso</p>
                        <p class="text-white text-lg font-mono mt-1" id="prof-email-display">carregando...</p>
                        <p class="text-xs text-red-500 mt-2">* Este e-mail não pode ser alterado.</p>
                    </div>
                </div>

                <!-- SECURITY TAB -->
                <div id="pcontent-security" class="hidden">
                    <div class="floating-input">
                        <input type="password" id="prof-pwd" placeholder=" ">
                        <label>Nova Senha</label>
                    </div>
                    <div class="floating-input">
                        <input type="password" id="prof-pwd-conf" placeholder=" ">
                        <label>Confirmar Nova Senha</label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-whizzy-red text-white py-3 rounded font-bold mt-4 hover:bg-red-700">SALVAR ALTERAÇÕES</button>
            </form>
        </div>
    </div>

    <!-- QUERY BUILDER SEARCH MODAL -->
    <div id="modal-search" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('modal-search')"></div>
        <div class="bg-white dark:bg-whizzy-surface w-full max-w-3xl rounded-lg relative z-10 h-[80vh] flex flex-col border border-gray-700">
            <!-- Header with Top-Left X -->
            <div class="p-4 border-b border-gray-700 flex items-center gap-4 bg-whizzy-input">
                <button onclick="closeModal('modal-search')" class="text-gray-400 hover:text-white"><i class="material-icons">close</i></button>
                <h3 class="font-bold text-lg text-white">Construtor de Consultas</h3>
            </div>
            
            <div class="p-4 bg-black border-b border-gray-800 grid grid-cols-1 md:grid-cols-4 gap-2">
                <input type="text" id="search-query" placeholder="Palavra-chave..." class="col-span-2 bg-whizzy-input border border-gray-700 p-2 rounded text-white">
                <select id="search-prio" class="bg-whizzy-input border border-gray-700 p-2 rounded text-white">
                    <option value="">Todas Prioridades</option>
                    <option value="0">Muito Alta</option>
                    <option value="1">Alta</option>
                </select>
                <button onclick="performSearch()" class="bg-whizzy-red text-white font-bold rounded hover:bg-red-700">EXECUTAR</button>
            </div>

            <div id="search-results" class="flex-1 overflow-y-auto bg-gray-900 p-4">
                <div class="text-center text-gray-500 mt-10 flex flex-col items-center">
                    <i class="material-icons text-4xl mb-2">search</i>
                    <p>Defina os filtros acima e execute a consulta.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- FORGOT PASSWORD -->
    <div id="modal-forgot" class="fixed inset-0 z-[90] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeModal('modal-forgot')"></div>
        <div class="bg-whizzy-surface w-full max-w-sm p-6 rounded relative z-10 border border-gray-700 shadow-xl">
            <button onclick="closeModal('modal-forgot')" class="absolute top-2 right-2 text-white"><i class="material-icons">close</i></button>
            <h3 class="font-bold mb-4 text-white">Recuperar Acesso</h3>
            <p class="text-sm text-gray-400 mb-4">Informe seu e-mail para receber um link de redefinição.</p>
            <input type="email" id="forgot-email" class="w-full bg-whizzy-input border border-gray-600 p-2 mb-4 rounded text-white" placeholder="E-mail">
            <button onclick="submitForgot()" class="w-full bg-whizzy-red text-white py-2 rounded font-bold hover:bg-red-700">ENVIAR</button>
        </div>
    </div>

    <!-- VIBE MODAL -->
    <div id="modal-vibe" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-4">
        <button onclick="closeModal('modal-vibe')" class="absolute top-4 right-4 text-white hover:text-red-500 z-50"><i class="material-icons text-4xl">close</i></button>
        <div class="max-w-2xl text-center relative">
            <div class="text-6xl mb-6 logo-anim mx-auto">⏳</div>
            <h2 class="text-3xl md:text-5xl font-serif text-whizzy-red mb-8 italic" id="vibe-text">"Carregando..."</h2>
            <div class="text-gray-500 text-sm tracking-widest">VIBE DO DIA</div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzc7GFA2uP0Cip1AyZJo6IWviO0oi2XFbAFH93_sSi8HKgQ_U5lStV6NPQbHzyarH2_Lw/exec'; 
        
        let STATE = {
            user: null,
            events: [],
            currentDate: new Date(),
            vibeId: 1,
            confirmCallback: null,
            isDark: true
        };

        window.onload = () => {
            if (localStorage.getItem('whizzy_theme') === 'light') {
                toggleTheme(false); 
            } else {
                document.documentElement.classList.add('dark');
            }

            const token = localStorage.getItem('whizzy_token');
            if (token) {
                loadProfile(token);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
            }
            
            populateSelects();
            initServiceWorker();
            
            document.getElementById('header-avatar').onclick = (e) => {
                e.stopPropagation();
                document.getElementById('user-dropdown').classList.toggle('hidden');
            };
            document.addEventListener('click', () => {
                document.getElementById('user-dropdown').classList.add('hidden');
            });
        };

        function scrollToNow() {
            setTimeout(() => {
                const h = new Date().getHours();
                const el = document.getElementById(`row-${h}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 600);
        }

        // =================================================================
        // UI HELPERS
        // =================================================================
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function showAlert(title, msg) {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            openModal('modal-alert');
        }

        function showConfirm(msg, callback) {
            document.getElementById('confirm-msg').innerText = msg;
            STATE.confirmCallback = callback;
            document.getElementById('btn-confirm-action').onclick = () => {
                callback();
                closeModal('modal-confirm');
            };
            openModal('modal-confirm');
        }

        function switchProfileTab(tab) {
            ['data', 'access', 'security'].forEach(t => {
                document.getElementById(`ptab-${t}`).className = t === tab 
                    ? 'flex-1 py-3 text-sm font-bold text-whizzy-red border-b-2 border-whizzy-red' 
                    : 'flex-1 py-3 text-sm font-bold text-gray-500 border-b-2 border-transparent';
                document.getElementById(`pcontent-${t}`).classList.toggle('hidden', t !== tab);
            });
        }

        function switchAuth(type) {
            document.getElementById('form-login').classList.toggle('hidden', type !== 'login');
            document.getElementById('form-register').classList.toggle('hidden', type !== 'register');
            document.getElementById('tab-login').className = type === 'login' ? 'flex-1 pb-2 text-whizzy-red border-b-2 border-whizzy-red font-bold' : 'flex-1 pb-2 text-gray-500';
            document.getElementById('tab-register').className = type === 'register' ? 'flex-1 pb-2 text-whizzy-red border-b-2 border-whizzy-red font-bold' : 'flex-1 pb-2 text-gray-500';
        }

        // =================================================================
        // AUTH
        // =================================================================
        async function handleLogin(e) {
            e.preventDefault();
            showLoader(true, "Autenticando...");
            try {
                const res = await apiCall({ action: 'LOGIN', payload: { email: document.getElementById('login-email').value, password: document.getElementById('login-pass').value } });
                loginSuccess(res.data);
            } catch (err) {
                showLoader(false);
                showAlert("Erro de Acesso", err.message);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const email = document.getElementById('reg-email').value;
            const confEmail = document.getElementById('reg-email-conf').value;
            if (email !== confEmail) return showAlert("Erro", "Os e-mails não conferem.");

            const pass = document.getElementById('reg-pass').value;
            const confPass = document.getElementById('reg-pass-conf').value;
            
            const regex = /^(?=.*[0-9])(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{8,}$/;
            if (!regex.test(pass)) return showAlert("Senha Fraca", "Mínimo 8 caracteres, com número e símbolo especial.");
            if (pass !== confPass) return showAlert("Erro", "As senhas não conferem.");
            
            // Checkboxes
            const wa = document.getElementById('chk-wa').checked;
            const sms = document.getElementById('chk-sms').checked;
            const tg = document.getElementById('chk-tg').checked;
            
            if(!wa && !sms && !tg) return showAlert("Erro", "Selecione ao menos um canal de alerta.");

            showConfirm(`Confirma a ativação desta chave e sua vinculação ao e-mail ${email} com estes dados?`, async () => {
                showLoader(true, "CRIANDO PLANNER...");
                const payload = {
                    key: document.getElementById('reg-key').value.toUpperCase(),
                    name: document.getElementById('reg-name').value,
                    email: email,
                    phone: document.getElementById('reg-phone').value,
                    password: pass,
                    notifyWA: wa, notifySMS: sms, notifyTG: tg
                };

                try {
                    const res = await apiCall({ action: 'REGISTER', payload });
                    loginSuccess(res.data);
                } catch (err) {
                    showLoader(false);
                    document.getElementById('form-register').reset(); // Clear form on error
                    showAlert("Erro no Cadastro", err.message);
                }
            });
        }

        function loginSuccess(data) {
            STATE.user = data;
            localStorage.setItem('whizzy_token', data.token);
            
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('header-avatar').src = data.photo || `https://ui-avatars.com/api/?name=${data.name}&background=DC2626&color=fff`;
            
            loadData();
        }

        // =================================================================
        // CORE API
        // =================================================================
        async function apiCall(body) {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(body) });
            const json = await res.json();
            if (json.status === 'ERROR') throw new Error(json.message);
            return json;
        }

        async function loadProfile(token) {
            showLoader(true, "SINCRONIZANDO...");
            try {
                const res = await apiCall({ action: 'GET_PROFILE', payload: { token } });
                STATE.events = res.data.events;
                STATE.vibeId = res.data.vibe;
                
                loginSuccess({ 
                    token, 
                    name: res.data.userMeta.name, 
                    photo: res.data.userMeta.photo, 
                    email: res.data.userMeta.email,
                    phone: res.data.userMeta.phone 
                }); 
            } catch (err) {
                localStorage.removeItem('whizzy_token');
                location.reload();
            } finally {
                showLoader(false);
            }
        }
        
        function loadData() {
            renderGrid();
            updateDateDisplay();
            showLoader(false);
            scrollToNow();
        }

        async function syncEvents() {
            try { await apiCall({ action: 'SYNC_EVENTS', payload: { token: STATE.user.token, events: STATE.events } }); } catch(e) { console.error(e); }
        }

        // =================================================================
        // GRID
        // =================================================================
        function renderGrid() {
            const container = document.getElementById('planner-grid');
            container.innerHTML = '';
            
            const selectedDateStr = STATE.currentDate.toISOString().split('T')[0];
            const now = new Date();
            const isToday = selectedDateStr === now.toISOString().split('T')[0];
            const currentHour = now.getHours();

            const dayEvents = STATE.events.filter(e => e.start.startsWith(selectedDateStr));

            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 15) {
                    const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                    
                    const div = document.createElement('div');
                    div.className = 'time-slot';
                    if(isToday && h === currentHour) div.classList.add('current-hour'); // Highlight current hour
                    if (m===0) div.id = `row-${h}`; 
                    
                    div.innerHTML = `<span class="time-label">${timeStr}</span>`;
                    
                    const addBtn = document.createElement('div');
                    addBtn.className = 'add-btn-slot';
                    addBtn.innerText = '(+)';
                    addBtn.onclick = (e) => { e.stopPropagation(); openEventModal(null, h, m); };
                    div.appendChild(addBtn);

                    const slotsEvents = dayEvents.filter(ev => {
                        const evTime = new Date(ev.start);
                        return evTime.getHours() === h && evTime.getMinutes() === m;
                    });

                    // Up to 3 events per slot logic handled by CSS Grid (3 columns)
                    slotsEvents.forEach((ev) => {
                        const el = document.createElement('div');
                        el.className = `event-chip prio-${ev.priority}`;
                        
                        const start = new Date(ev.start);
                        const end = new Date(ev.end);
                        const durationMins = (end - start) / 60000;
                        const heightPx = (durationMins / 15) * 80;
                        
                        el.style.height = `calc(${heightPx}px - 4px)`;
                        el.style.zIndex = 10;
                        el.innerHTML = `
                            <div class="font-bold truncate leading-tight">${ev.title}</div>
                            <div class="chip-actions">
                                <i class="material-icons text-xs action-icon" onclick="eventAction(event, 'view', '${ev.id}')">visibility</i>
                                <i class="material-icons text-xs action-icon" onclick="eventAction(event, 'edit', '${ev.id}')">edit</i>
                                <i class="material-icons text-xs action-icon" onclick="eventAction(event, 'delete', '${ev.id}')">delete</i>
                            </div>
                        `;
                        div.appendChild(el);
                    });
                    container.appendChild(div);
                }
            }
        }

        function eventAction(e, type, id) {
            e.stopPropagation();
            const evt = STATE.events.find(ev => ev.id === id);
            if (!evt) return;

            if (type === 'delete') {
                const isPast = new Date(evt.end) < new Date();
                if (isPast) return showAlert("Ação Negada", "Não é permitido apagar a história.");
                
                showConfirm("Excluir este compromisso?", () => {
                    STATE.events = STATE.events.filter(x => x.id !== id);
                    renderGrid();
                    syncEvents();
                });
            } else {
                openEventModal(evt);
            }
        }

        function openEventModal(eventObj, h, m) {
            const modal = document.getElementById('modal-event');
            const form = document.getElementById('form-event');
            modal.classList.remove('hidden');
            
            if (eventObj) {
                // EDIT
                const isPast = new Date(eventObj.end) < new Date();
                document.getElementById('modal-title-text').innerText = isPast ? "Visualizar Histórico" : "Editar Compromisso";
                document.getElementById('evt-id').value = eventObj.id;
                document.getElementById('evt-title').value = eventObj.title;
                document.getElementById('evt-notes').value = eventObj.notes;
                document.getElementById('evt-priority').value = eventObj.priority;
                document.getElementById('div-status').classList.remove('hidden');
                document.getElementById('evt-status').value = eventObj.status;

                const d = new Date(eventObj.start);
                const end = new Date(eventObj.end);
                const durationMins = (end - d) / 60000;
                
                document.getElementById('evt-start-h').value = d.getHours();
                document.getElementById('evt-start-m').value = d.getMinutes() === 0 ? "00" : d.getMinutes();
                document.getElementById('evt-dur-h').value = Math.floor(durationMins / 60);
                document.getElementById('evt-dur-m').value = durationMins % 60;

                const fieldsToLock = ['evt-title', 'evt-start-h', 'evt-start-m', 'evt-dur-h', 'evt-dur-m'];
                fieldsToLock.forEach(id => document.getElementById(id).disabled = isPast);

            } else {
                // CREATE
                document.getElementById('modal-title-text').innerText = "Novo Compromisso";
                form.reset();
                document.getElementById('evt-id').value = "";
                document.getElementById('evt-start-h').value = h;
                document.getElementById('evt-start-m').value = m === 0 ? "00" : m;
                document.getElementById('evt-dur-h').value = 1; 
                document.getElementById('evt-dur-m').value = 0;
                document.getElementById('div-status').classList.add('hidden');
                
                // Past check logic in saveEvent, but here we unlock everything
                ['evt-title', 'evt-start-h', 'evt-start-m', 'evt-dur-h', 'evt-dur-m'].forEach(id => document.getElementById(id).disabled = false);
            }
        }

        function saveEvent(e) {
            e.preventDefault();
            const id = document.getElementById('evt-id').value || Date.now().toString();
            const h = parseInt(document.getElementById('evt-start-h').value);
            const m = parseInt(document.getElementById('evt-start-m').value);
            const durH = parseInt(document.getElementById('evt-dur-h').value);
            const durM = parseInt(document.getElementById('evt-dur-m').value);
            
            const start = new Date(STATE.currentDate);
            start.setHours(h, m, 0, 0);
            const end = new Date(start);
            end.setMinutes(end.getMinutes() + (durH * 60) + durM);
            
            // STRICT PAST BLOCK
            if (!document.getElementById('evt-id').value && start < new Date()) {
                return showAlert("Erro Temporal", "Não é permitido agendar no passado.");
            }

            const newEvt = {
                id,
                title: document.getElementById('evt-title').value,
                start: start.toISOString(),
                end: end.toISOString(),
                priority: document.getElementById('evt-priority').value,
                status: document.getElementById('evt-id').value ? document.getElementById('evt-status').value : 'OPEN',
                notes: document.getElementById('evt-notes').value,
                color: 'DEFAULT'
            };

            STATE.events = STATE.events.filter(e => e.id !== id);
            STATE.events.push(newEvt);
            closeModal('modal-event');
            renderGrid();
            syncEvents();
        }

        // =================================================================
        // SETTINGS & MISC
        // =================================================================
        function openProfile() {
            document.getElementById('prof-name').value = STATE.user.name;
            document.getElementById('prof-photo').value = STATE.user.photo;
            document.getElementById('prof-phone').value = STATE.user.phone || "";
            document.getElementById('prof-email-display').innerText = STATE.user.email; // Readonly display
            switchProfileTab('data'); // Default tab
            openModal('modal-profile');
        }

        async function updateProfileSubmit(e) {
            e.preventDefault();
            const p1 = document.getElementById('prof-pwd').value;
            const p2 = document.getElementById('prof-pwd-conf').value;
            if (p1 && p1 !== p2) return showAlert("Erro", "Senhas não conferem.");

            showLoader(true, "Atualizando...");
            try {
                const payload = {
                    token: STATE.user.token,
                    name: document.getElementById('prof-name').value,
                    photo: document.getElementById('prof-photo').value,
                    phone: document.getElementById('prof-phone').value,
                    password: p1 || null
                };
                await apiCall({ action: 'UPDATE_PROFILE', payload });
                STATE.user.name = payload.name;
                STATE.user.photo = payload.photo;
                STATE.user.phone = payload.phone;
                document.getElementById('header-avatar').src = payload.photo || `https://ui-avatars.com/api/?name=${payload.name}&background=DC2626&color=fff`;
                closeModal('modal-profile');
                showAlert("Sucesso", "Perfil atualizado.");
            } catch(err) { showAlert("Erro", err.message); } finally { showLoader(false); }
        }

        async function submitForgot() {
            try {
                await apiCall({ action: 'RESET_PASSWORD', payload: { email: document.getElementById('forgot-email').value } });
                closeModal('modal-forgot');
                showAlert("E-mail Enviado", "Verifique sua caixa de entrada.");
            } catch(err) { showAlert("Erro", err.message); }
        }

        async function generateTestKey() {
            showLoader(true, "Gerando...");
            try {
                const res = await apiCall({ action: 'GENERATE_DEV_KEY', payload: {} });
                document.getElementById('reg-key').value = res.data.key;
            } catch(e) { showAlert("Erro", e.message); } finally { showLoader(false); }
        }

        function performSearch() {
            const q = document.getElementById('search-query').value.toLowerCase();
            const p = document.getElementById('search-prio').value;
            
            const results = STATE.events.filter(e => {
                const matchText = e.title.toLowerCase().includes(q) || e.notes.toLowerCase().includes(q);
                const matchPrio = p === "" || e.priority == p;
                return matchText && matchPrio;
            }).sort((a,b) => new Date(b.start) - new Date(a.start));

            const container = document.getElementById('search-results');
            container.innerHTML = '';
            if(results.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">Nada encontrado.</p>';
                return;
            }
            results.forEach(ev => {
                const el = document.createElement('div');
                el.className = `p-3 mb-2 rounded border-l-4 prio-${ev.priority} bg-whizzy-input cursor-pointer hover:opacity-80`;
                el.innerHTML = `<div class="font-bold text-white">${ev.title}</div><div class="text-xs text-gray-400">${new Date(ev.start).toLocaleString()}</div>`;
                el.onclick = () => { STATE.currentDate = new Date(ev.start); updateDateDisplay(); renderGrid(); closeModal('modal-search'); };
                container.appendChild(el);
            });
        }

        function showLoader(show, text) {
            const el = document.getElementById('loader');
            if(show) {
                el.classList.remove('hidden');
                document.getElementById('loader-text').innerText = text || "CARREGANDO...";
            } else {
                el.classList.add('hidden');
            }
        }

        function changeDay(delta) { STATE.currentDate.setDate(STATE.currentDate.getDate() + delta); updateDateDisplay(); renderGrid(); }
        function jumpToDate(val) { const [y, m, d] = val.split('-'); STATE.currentDate = new Date(y, m-1, d); updateDateDisplay(); renderGrid(); }
        function jumpToToday() { STATE.currentDate = new Date(); updateDateDisplay(); renderGrid(); scrollToNow(); }

        function updateDateDisplay() {
            const str = STATE.currentDate.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('header-date').innerText = str.charAt(0).toUpperCase() + str.slice(1);
        }

        function toggleTheme(isDark = true) {
            STATE.isDark = isDark;
            if(isDark) { document.documentElement.classList.add('dark'); localStorage.setItem('whizzy_theme', 'dark'); }
            else { document.documentElement.classList.remove('dark'); localStorage.setItem('whizzy_theme', 'light'); }
        }
        
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('w-64'); sb.classList.toggle('w-0');
            sb.classList.toggle('px-4'); sb.classList.toggle('px-0');
        }

        function showVibe() {
             // Mock
             document.getElementById('vibe-text').innerText = "O futuro pertence àqueles que se preparam hoje.";
             openModal('modal-vibe');
        }

        function toggleMobileMenu() { document.getElementById('mobile-menu').classList.toggle('-translate-x-full'); }
        
        function confirmLogout() { showConfirm("Sair do sistema?", () => { localStorage.removeItem('whizzy_token'); location.reload(); }); }
        
        function populateSelects() {
            const selH = document.getElementById('evt-start-h'), durH = document.getElementById('evt-dur-h');
            for(let i=0; i<24; i++) {
                const opt = `<option value="${i}">${i.toString().padStart(2,'0')}</option>`;
                selH.innerHTML += opt; durH.innerHTML += opt;
            }
        }
        function initServiceWorker() { if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(e=>console.log(e)); }
    </script>
</body>
</html>
